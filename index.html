<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<link rel="shortcut icon"
		href="https://static-index-4gtuqm3bfa95c963-1304825656.tcloudbaseapp.com/official-website/favicon.svg"
		mce_href="https://static-index-4gtuqm3bfa95c963-1304825656.tcloudbaseapp.com/official-website/favicon.svg"
		type="image/x-icon" />
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://unpkg.com/vant@2.12/lib/index.css" />
	<!-- 引入 Vue 和 Vant 的 JS 文件 -->
	<script src="https://unpkg.com/vue@2.6/dist/vue.min.js"></script>
	<script src="https://unpkg.com/vant@2.12/lib/vant.min.js"></script>
	<title>信息填报</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Droid Sans", "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", sans-serif;
			background-color: #4694ff;
		}

		.title-logo {
			width: 80px;
			height: 80px;
		}

		.container {
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.container .form {
			width: 97%;
			margin: 20px auto 0;
			background-color: #fff;
			border-radius: 7px;
		}

		.container .form .fItem {
			padding: 4% 3%;
			color: #555;
			border-bottom: 1px solid #eaeaea;
		}

		.container .form .fItem:nth-last-child(1) {
			border-bottom: none;
		}

		.container .form .fItem span {
			display: block;
			margin-bottom: 6px;
		}

		.container .form .fItem input {
			border: none;
			outline: none;
			display: block;
		}

		.container .handleSubmit {
			margin: 8% 0;
			width: 96%;
			background-color: #ffffff;
			color: #4694ff;
			text-align: center;
			padding: 3% 0;
			border-radius: 50px;
		}

		.container .loading {
			position: fixed;
			width: 50%;
			top: 42%;
			transform: translateY(-50%);
			text-align: center;
		}

		.count-button {
			width: 320px;
			height: 40px;
			box-sizing: border-box;
			margin: 16px 8px;
			font-weight: 500;
			font-size: 17px;
			color: #FFFFFF;
			letter-spacing: 1px;
			text-align: center;
			border-radius: 4px;
		}

		.count-number {
			align-self: flex-start;
			opacity: 0.9;
			font-weight: 500;
			font-size: 14px;
			color: #000000;
		}

		.count-reset {
			color: #576b95;
			cursor: pointer;
			margin-left: auto;
		}

		.count-text {
			width: 320px;
			height: 40px;
			padding: 0 12px;
			margin: 0 auto;
			line-height: 40px;
			text-align: left;
			display: flex;
			border: 1px solid rgba(0, 0, 0, 0.1);
			border-radius: 4px;
			opacity: 0.9;
			box-sizing: border-box;
			font-weight: 400;
			font-size: 14px;
			color: #000000;
		}

		.quote {
			font-size: 12px;
		}

		.qrcode {
			height: 144px;
			width: 144px;
			display: block;
			margin: 0 auto;
		}

		.title {
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			width: 320px;
		}

		.title-text {
			width: 320px;
			height: 48px;
			text-align: center;
			margin-top: 16px;
			font-size: 32px;
			opacity: 0.9;
			font-weight: 500;
			font-size: 32px;
			color: #000000;
			letter-spacing: 0;
			line-height: 48px;
		}

		.counter-container {
			margin-top: 48px;
		}

		.hr {
			text-align: center;
			position: relative;
			z-index: 2;
			height: 20px;
			line-height: 20px;
		}

		.hr::after {
			position: absolute;
			content: '';
			top: 10px;
			left: 60px;
			width: 200px;
			border-bottom: 1px solid rgba(0, 0, 0, .1);
			z-index: -1;
		}

		.hr small {
			display: inline-block;
			background-color: white;
		}

		.hr-text {
			display: inline-block;
			height: 20px;
			font-weight: 400;
			font-size: 14px;
			color: rgba(0, 0, 0, 0.55);
			letter-spacing: 0;
			text-align: center;
			z-index: 2;
			background-color: white;
			padding: 0 8px;
			line-height: 20px;
		}

		.link-button {
			width: 154px;
			height: 48px;
			box-sizing: border-box;
			font-weight: 400;
			font-size: 14px;
			color: rgba(0, 0, 0, 0.90);
			letter-spacing: 0;
			text-align: center;
			background: rgba(0, 0, 0, 0.03);
			border-radius: 6px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.card {
			margin-top: 16px;
			width: 320px;
			height: 200px;
			box-sizing: border-box;
			border: 1px solid rgba(0, 0, 0, 0.10);
			border-radius: 5.71px;
			position: relative;
		}

		.card-text {
			text-align: center;
			font-weight: 400;
			font-size: 14px;
			color: rgba(0, 0, 0, 0.55);
			letter-spacing: 0;
		}
	</style>
	<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
	<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
	<script src="https://web-9gikcbug35bad3a8-1304825656.tcloudbaseapp.com/sdk/1.3.0/cloud.js"></script>
	<script src="https://web-9gikcbug35bad3a8-1304825656.tcloudbaseapp.com/sdk/1.3.1/mplogin.min.js"></script>
</head>

<body>
	<div class="container" id="index">
		<div class="form">
			<div class="fItem">
				<span>车牌号</span>
				<input type="text" placeholder="请输入车牌号" v-bind:value="formInfo.carNo"
					v-on:input="formInfo.carNo = $event.target.value">
			</div>
			<div class="fItem">
				<span>车辆吨位</span>
				<input type="text" placeholder="请输入车辆吨位" v-bind:value="formInfo.dunwei"
					v-on:input="formInfo.dunwei = $event.target.value">
			</div>
			<div class="fItem">
				<span>危化品运输编号</span>
				<input type="number" placeholder="请输入危化品运输编号" v-bind:value="formInfo.weihuapin"
					v-on:input="formInfo.weihuapin = $event.target.value">
				<!-- oninput="value=value.replace(/[^0-9.]/g,'')" -->
			</div>
			<div class="fItem">
				<span>联系人</span>
				<input type="text" placeholder="请输入联系人" v-bind:value="formInfo.name"
					v-on:input="formInfo.name = $event.target.value">
			</div>
			<div class="fItem">
				<span>联系方式</span>
				<input type="text" placeholder="请输入联系方式" v-bind:value="formInfo.moble"
					v-on:input="formInfo.moble = $event.target.value">
			</div>
			<div class="fItem">
				<span>车辆状况</span>
				<input type="text" placeholder="请输入车辆状况" v-bind:value="formInfo.zhuangkuang"
					v-on:input="formInfo.zhuangkuang = $event.target.value">
			</div>
		</div>
		<div class="handleSubmit" @click="handleSubmit">提交</div>
		<div class="loading" v-if="loadingVis">
			<van-loading color="#0094ff" vertical>加载中...</van-loading>
		</div>
	</div>
</body>
<script src="https://mat1.gtimg.com/www/asset/lib/jquery/jquery/jquery-1.11.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
	</script>
<script>
	new Vue({
		el: "#index",
		data() {
			return {
				loadingVis: false,
				CurRecordID: 0,//用户当前的车辆记录ID
				CurUserInfo: {}, //当前用户信息
				phoneReg: /^1[3|4|5|7|8][0-9]\d{8}$/,
				isUpload: false,//true为修改信息
				formInfo: {
					carNo: '',
					dunwei: '',
					weihuapin: '',
					name: '',
					moble: '',
					zhuangkuang: '',
				},
			};
		},
		async created() {
			this.loadingVis = true;
			let myappid = "wxa806018a131603d3";
			const vConsole = new window.VConsole();
			const result = await window.mplogin({
				scope: "snsapi_userinfo", // 必填，登录方式：snsapi_userinfo、snsapi_base
				appid: myappid, // 必填，公众号appid，将以此 appid 名义进行请求
				// redirect: '',                      // 选填，授权成功后路由的地址，目标地址应能处理授权参数，不填为当前页面
				envid: 'prod-4g9w3eru303c9c3a', // 选填，资源方微信云托管环境，如果传递此参数则会返回初始化的 cloud 操作对象
				resourceAppid: myappid, // 选填，如果是资源复用模式，需要填资源方微信账号
				signature: window.location.href // 选填，如果需要微信 SDK 的API方法，则填写要使用的地址，会返回 signature 签名对象，envid参数不填则无效
			})
			try {
				if (result.ret === 0) {
					window.app = result.cloud
					const callres = await window.app.callContainer({
						path: '/api/GetUserInfo',
						method: 'POST',
						header: {
							'X-WX-SERVICE': 'golang-zqzy',
							'X-WX-CLOUDID': result.info
						},
						config: {
							'env': 'prod-4g9w3eru303c9c3a'
						},
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						data: JSON.stringify({
							"openid": result.info
						})
					})
					this.CurUserInfo = callres.data;
					console.log(this.CurUserInfo)
					//获取该用户的最近的停车记录
					this.getOne();
				} else { // ret不为0时，代表登录出现错误，一般出现在开发调试中，正式使用一般只有2-系统拦截错误
					// 登录出现问题，打印问题描述
					//window.alert(result.msg)
				}
			} catch (e) {
				console.log(e)
			}
		},
		methods: {
			async handleSubmit() {
				var that = this;
				for (let i in this.formInfo) {
					if (!this.formInfo[i]) {
						vant.Notify({ type: 'warning', message: '请填写完整数据' });
						return false
					}
				}
				if (!this.phoneReg.test(this.formInfo.moble)) {
					vant.Notify({ type: 'warning', message: '请输入正确的手机号' });
					return false
				}
				if (this.isUpload) {
					// 修改
					await window.app.callContainer({
						path: '/api/CarUpdate',
						method: 'POST',
						header: {
							'X-WX-SERVICE': 'golang-zqzy',
						},
						config: {
							'env': 'prod-4g9w3eru303c9c3a'
						},
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						data: JSON.stringify({
							"id": that.formInfo.id,
							"carNo": that.formInfo.carNo,
							"dunwei": Number(that.formInfo.dunwei),
							"weihuapin": that.formInfo.weihuapin,
							"name": that.formInfo.name,
							"moble": that.formInfo.moble,
							"zhuangkuang": that.formInfo.zhuangkuang,
						}),
						success: function (res) {
							if (res.data.code == 0) {
								vant.Toast.success('修改成功');
								localStorage.setItem("formInfo", JSON.stringify(that.formInfo));
							}
						},
						fail: function (res) {
							console.log(JSON.stringify(res))
						}
					})
				} else {
					// 新增
					await window.app.callContainer({
						path: '/api/CarInsert',
						method: 'POST',
						header: {
							'X-WX-SERVICE': 'golang-zqzy',
						},
						config: {
							'env': 'prod-4g9w3eru303c9c3a'
						},
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						data: JSON.stringify({
							"wechartid": that.CurUserInfo["data"],
							"carNo": that.formInfo.carNo,
							"dunwei": Number(that.formInfo.dunwei),
							"weihuapin": that.formInfo.weihuapin,
							"name": that.formInfo.name,
							"moble": that.formInfo.moble,
							"zhuangkuang": that.formInfo.zhuangkuang,
						}),
						success: function (res) {
							if (res.data.code == 0) {
								localStorage.setItem("formInfo", JSON.stringify(that.formInfo));
								vant.Toast.success('提交成功');
							}
						},
						fail: function (res) {
							console.log(JSON.stringify(res))
						}
					})
				}
			},
			async getOne() {
				console.log('getOne');
				var that = this;
				await window.app.callContainer({
					path: '/api/CarGet',
					method: 'POST',
					header: {
						'X-WX-SERVICE': 'golang-zqzy',
					},
					config: {
						'env': 'prod-4g9w3eru303c9c3a'
					},
					contentType: "application/json; charset=utf-8",
					dataType: "json",
					data: JSON.stringify({
						"wechartid": that.CurUserInfo["data"],
					}),
					success: function (res) {
						if (res.data.data.CarNo) {
							that.isUpload = true;
							that.formInfo = {
								id: res.data.data.ID,
								carNo: res.data.data.CarNo,
								dunwei: res.data.data.dunwei,
								weihuapin: res.data.data.weihuapin,
								name: res.data.data.name,
								moble: res.data.data.moble,
								zhuangkuang: res.data.data.zhuangkuang,
							};
						} else {
							// 查看缓存是否存在
							let info = localStorage.getItem("formInfo");
							if (info) {
								that.formInfo = JSON.parse(info);
							}
						}
						that.loadingVis = false;
					},
					fail: function (res) {
						console.log(JSON.stringify(res))
					}
				})

			},
		}
	})
</script>

</html>
